<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import amqplib from 'amqplib';
import consumer from './consume';
import Publisher from './publish';
import { encode } from './lib/contentEncoding';
import { pack } from './lib/contentType';
import './types/amqp';

/**
 * @description Replies to a message with a response. If message is not meant to be responded to,
 *  it will simply ack the message.
 * @param {Message} message
 * @param {channel} channel
 * @param {Any} response
 * @param {MessageProperties} [options] Defaults content type to 'application/json' and
 *  contentEncoding to 'base64'.
 */
export const reply = (
  message,
  channel,
  response,
  {
    contentType = 'application/json',
    contentEncoding = 'base64',
    ...options
  } = {},
) => {
  if (
    message.properties.replyTo !== null
    &amp;&amp; typeof message.properties.replyTo !== 'undefined'
  ) {
    const packedMessage = pack(response, contentType);
    channel.publish(
      '',
      message.properties.replyTo,
      encode(packedMessage, contentEncoding),
      {
        ...options,
        contentType,
        contentEncoding,
        correlationId: message.properties.correlationId,
      },
    );
  }

  channel.ack(message);
  return Promise.resolve(true);
};

/**
 * nodeMQ object
 * @typedef {Object} nodeMQ
 * @property {Function} connection Returns a promise resolving the connection
 * @property {Function} disconnect Disconnects from the server and closes the connection
 * @property {Consumer} consume
 * @property {Function} reply
 */

/**
 * @description Creates a nodeMQ connection object to rabbitmq
 * @param {string} connectionURL rabbitmq connection url
 * @return {nodeMQ} nodeMQ
 * @example
 *   import nodejsmq from 'nodejsmq';
 *
 *   const nodeMQ = nodejsmq('amqp://localhost/');
 *   nodeMQ.publishMessage('myqueue','Hello World')
 *   .then((response)=> {
 *     console.log(response);
 *     nodeMQ.disconnect();
 *   });
 */
const nodeMQ = (connectionURL) => {
  let connection = null;

  const connect = () => {
    if (connection) {
      return Promise.resolve(connection);
    }

    return amqplib.connect(connectionURL)
      .then((conn) => { connection = conn; })
      .then(() => connection);
  };

  const publisher = Publisher(connect());

  return {
    /**
     * @description returns promise resolving connection
     */
    connection: connect(),

    /**
     * @description closes the connection
     */
    disconnect: () => connection.close,

    consume: consumer(connect()),
    publish: publisher.publish,
    publishMessage: publisher.publishMessage,
    reply,
  };
};

export default nodeMQ;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#connection">connection</a></li><li><a href="global.html#consumer">consumer</a></li><li><a href="global.html#ConsumingCallback">ConsumingCallback</a></li><li><a href="global.html#disconnect">disconnect</a></li><li><a href="global.html#MessageHandler">MessageHandler</a></li><li><a href="global.html#reply">reply</a></li><li><a href="global.html#types">types</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
